<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†ç»„è¿‡æ»¤å™¨åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f7;
        }

        .test-container {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .test-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #007AFF;
            padding-bottom: 10px;
        }

        .test-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1d1d1f;
        }

        .test-status {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending { background: #f2f2f7; color: #666; }
        .status-running { background: #e3f2fd; color: #1976d2; }
        .status-passed { background: #e8f5e8; color: #2e7d32; }
        .status-failed { background: #ffebee; color: #d32f2f; }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #fafafa;
            border-radius: 8px;
            border-left: 4px solid #007AFF;
        }

        .test-case {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .test-case.running {
            border-color: #2196F3;
            background: #e3f2fd;
        }

        .test-case.passed {
            border-color: #4CAF50;
            background: #e8f5e8;
        }

        .test-case.failed {
            border-color: #f44336;
            background: #ffebee;
        }

        .test-case h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
        }

        .test-description {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }

        .test-input {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 5px 0;
            white-space: pre-wrap;
            border: 1px solid #ddd;
        }

        .test-output {
            background: #e8f5e8;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 5px 0;
            border: 1px solid #4CAF50;
        }

        .test-error {
            background: #ffebee;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 5px 0;
            border: 1px solid #f44336;
            color: #d32f2f;
        }

        .test-controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .test-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .test-btn.primary {
            background: #007AFF;
            color: white;
        }

        .test-btn.secondary {
            background: #f2f2f7;
            color: #333;
        }

        .test-btn.danger {
            background: #ff3b30;
            color: white;
        }

        .test-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .test-results {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007AFF, #34C759);
            width: 0%;
            transition: width 0.3s ease;
        }

        .iframe-container {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin: 20px 0;
        }

        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .test-data {
            display: none;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .stat-card {
            padding: 15px;
            background: white;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 24px;
            font-weight: 600;
            color: #007AFF;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1 class="test-title">ğŸ§ª åˆ†ç»„è¿‡æ»¤å™¨åŠŸèƒ½æµ‹è¯•</h1>
            <div class="test-status">
                <span class="status-badge status-pending" id="overall-status">å‡†å¤‡ä¸­</span>
            </div>
        </div>

        <div class="summary-stats" id="summary-stats">
            <div class="stat-card">
                <div class="stat-number" id="total-tests">0</div>
                <div class="stat-label">æ€»æµ‹è¯•æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="passed-tests">0</div>
                <div class="stat-label">é€šè¿‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="failed-tests">0</div>
                <div class="stat-label">å¤±è´¥</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="success-rate">0%</div>
                <div class="stat-label">æˆåŠŸç‡</div>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>

        <div class="test-controls">
            <button class="test-btn primary" onclick="runAllTests()">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <button class="test-btn secondary" onclick="runBasicTests()">ğŸ” åŸºç¡€åŠŸèƒ½æµ‹è¯•</button>
            <button class="test-btn secondary" onclick="runAdvancedTests()">âš¡ é«˜çº§åŠŸèƒ½æµ‹è¯•</button>
            <button class="test-btn secondary" onclick="runUITests()">ğŸ¨ UIäº¤äº’æµ‹è¯•</button>
            <button class="test-btn danger" onclick="clearAllTests()">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
            <button class="test-btn secondary" onclick="exportResults()">ğŸ“„ å¯¼å‡ºæŠ¥å‘Š</button>
        </div>
    </div>

    <!-- åº”ç”¨ç¨‹åºiframe -->
    <div class="test-container">
        <h3>ğŸ–¥ï¸ åº”ç”¨ç¨‹åºé¢„è§ˆ</h3>
        <div class="iframe-container">
            <iframe src="index.html" id="app-iframe"></iframe>
        </div>
    </div>

    <!-- æµ‹è¯•ç”¨ä¾‹éƒ¨åˆ† -->
    <div class="test-container">
        <h3>ğŸ“‹ æµ‹è¯•ç”¨ä¾‹è¯¦æƒ…</h3>
        <div id="test-sections"></div>
    </div>

    <!-- éšè—çš„æµ‹è¯•æ•°æ® -->
    <div class="test-data">
        <div id="test-inputs">
            <div data-name="danbooru-sample">General
?
1girl 6.1M
long hair 3.2M
blue eyes 2.1M
?
nsfw 500K
watermark 100K</div>
            <div data-name="gelbooru-sample">Artist? nekotokage 169Character? shirayuki tomoe 939Tag? 1girl 8032615 long hair 5429123 blue eyes 3241567 nsfw 892456</div>
            <div data-name="standard-sample">masterpiece, best quality, 1girl, long hair, blue eyes, watermark, nsfw, bad quality</div>
            <div data-name="complex-sample">1girl, red hat, hat, beautiful girl, girl, sfw, nsfw, masterpiece, best quality, quality</div>
        </div>
    </div>

    <script>
        // æµ‹è¯•é…ç½®
        const testConfig = {
            totalTests: 0,
            passedTests: 0,
            failedTests: 0,
            currentTest: 0,
            testResults: [],
            startTime: null,
            iframe: null
        };

        // æµ‹è¯•ç”¨ä¾‹å®šä¹‰
        const testSuites = {
            basic: {
                name: 'åŸºç¡€åŠŸèƒ½æµ‹è¯•',
                tests: [
                    {
                        name: 'FilterManageråˆå§‹åŒ–',
                        description: 'éªŒè¯GroupedFilterManageræ­£ç¡®åˆå§‹åŒ–',
                        test: async () => {
                            const app = await getAppInstance();
                            return app.filterManager instanceof app.GroupedFilterManager;
                        }
                    },
                    {
                        name: 'é…ç½®åŠ è½½å’Œä¿å­˜',
                        description: 'éªŒè¯é…ç½®çš„æŒä¹…åŒ–åŠŸèƒ½',
                        test: async () => {
                            const app = await getAppInstance();
                            const originalGroups = app.filterManager.groups.length;
                            
                            // æ·»åŠ æµ‹è¯•ç»„
                            app.filterManager.addGroup('æµ‹è¯•ç»„');
                            const newGroups = app.filterManager.groups.length;
                            
                            return newGroups === originalGroups + 1;
                        }
                    },
                    {
                        name: 'ç©ºçŠ¶æ€å¤„ç†',
                        description: 'éªŒè¯æ— ç»„æ—¶çš„ç©ºçŠ¶æ€æ˜¾ç¤º',
                        test: async () => {
                            const app = await getAppInstance();
                            
                            // æ¸…ç©ºæ‰€æœ‰ç»„
                            app.filterManager.groups = [];
                            await simulateUIUpdate(app);
                            
                            const emptyState = getElement('empty-state');
                            return emptyState && emptyState.style.display !== 'none';
                        }
                    }
                ]
            },
            groupManagement: {
                name: 'ç»„ç®¡ç†åŠŸèƒ½',
                tests: [
                    {
                        name: 'æ·»åŠ æ–°ç»„',
                        description: 'éªŒè¯æ–°ç»„åˆ›å»ºåŠŸèƒ½',
                        test: async () => {
                            const app = await getAppInstance();
                            const initialCount = app.filterManager.groups.length;
                            
                            const newGroup = app.filterManager.addGroup('æ–°æµ‹è¯•ç»„');
                            
                            return newGroup && 
                                   newGroup.name === 'æ–°æµ‹è¯•ç»„' && 
                                   app.filterManager.groups.length === initialCount + 1;
                        }
                    },
                    {
                        name: 'å¤åˆ¶ç»„',
                        description: 'éªŒè¯ç»„å¤åˆ¶åŠŸèƒ½',
                        test: async () => {
                            const app = await getAppInstance();
                            
                            // åˆ›å»ºæºç»„
                            const sourceGroup = app.filterManager.addGroup('æºç»„');
                            sourceGroup.keywords = ['test1', 'test2'];
                            sourceGroup.replacement = 'replacement';
                            
                            // å¤åˆ¶ç»„
                            const duplicatedGroup = app.filterManager.duplicateGroup(sourceGroup.id);
                            
                            return duplicatedGroup && 
                                   duplicatedGroup.name === 'æºç»„(å‰¯æœ¬)' &&
                                   duplicatedGroup.keywords.length === 2 &&
                                   duplicatedGroup.replacement === 'replacement';
                        }
                    },
                    {
                        name: 'åˆ é™¤ç»„',
                        description: 'éªŒè¯ç»„åˆ é™¤åŠŸèƒ½',
                        test: async () => {
                            const app = await getAppInstance();
                            
                            const testGroup = app.filterManager.addGroup('å¾…åˆ é™¤ç»„');
                            const initialCount = app.filterManager.groups.length;
                            
                            const result = app.filterManager.deleteGroup(testGroup.id);
                            
                            return result && app.filterManager.groups.length === initialCount - 1;
                        }
                    },
                    {
                        name: 'æ›´æ–°ç»„',
                        description: 'éªŒè¯ç»„ä¿¡æ¯æ›´æ–°åŠŸèƒ½',
                        test: async () => {
                            const app = await getAppInstance();
                            
                            const testGroup = app.filterManager.addGroup('åŸå§‹ç»„å');
                            const result = app.filterManager.updateGroup(testGroup.id, {
                                name: 'æ›´æ–°åçš„ç»„å',
                                enabled: false
                            });
                            
                            const updatedGroup = app.filterManager.getGroup(testGroup.id);
                            
                            return result && 
                                   updatedGroup.name === 'æ›´æ–°åçš„ç»„å' &&
                                   updatedGroup.enabled === false;
                        }
                    },
                    {
                        name: 'ç»„æ’åº',
                        description: 'éªŒè¯ç»„é¡ºåºè°ƒæ•´åŠŸèƒ½',
                        test: async () => {
                            const app = await getAppInstance();
                            
                            // åˆ›å»ºå¤šä¸ªç»„
                            app.filterManager.groups = [];
                            const group1 = app.filterManager.addGroup('ç»„1');
                            const group2 = app.filterManager.addGroup('ç»„2');
                            const group3 = app.filterManager.addGroup('ç»„3');
                            
                            // é‡æ–°æ’åº
                            app.filterManager.reorderGroups([group3.id, group1.id, group2.id]);
                            
                            return app.filterManager.groups[0].id === group3.id &&
                                   app.filterManager.groups[1].id === group1.id &&
                                   app.filterManager.groups[2].id === group2.id;
                        }
                    }
                ]
            },
            filterAlgorithm: {
                name: 'è¿‡æ»¤ç®—æ³•æµ‹è¯•',
                tests: [
                    {
                        name: 'å•ç»„åŸºç¡€è¿‡æ»¤',
                        description: 'éªŒè¯å•ä¸ªç»„çš„åŸºç¡€è¿‡æ»¤åŠŸèƒ½',
                        test: async () => {
                            const app = await getAppInstance();
                            
                            // è®¾ç½®æµ‹è¯•ç»„
                            app.filterManager.groups = [];
                            const testGroup = app.filterManager.addGroup('æµ‹è¯•è¿‡æ»¤');
                            testGroup.keywords = ['nsfw', 'watermark'];
                            
                            app.filterManager.setMasterEnabled(true);
                            
                            const input = ['1girl', 'nsfw', 'watermark', 'best quality'];
                            const result = app.filterManager.applyFilter(input);
                            
                            return result.includes('1girl') && 
                                   result.includes('best quality') &&
                                   !result.includes('nsfw') && 
                                   !result.includes('watermark');
                        }
                    },
                    {
                        name: 'æ›¿æ¢çŸ­è¯­åŠŸèƒ½',
                        description: 'éªŒè¯æ›¿æ¢çŸ­è¯­æ­£ç¡®æ’å…¥',
                        test: async () => {
                            const app = await getAppInstance();
                            
                            app.filterManager.groups = [];
                            const testGroup = app.filterManager.addGroup('æ›¿æ¢æµ‹è¯•');
                            testGroup.keywords = ['nsfw'];
                            testGroup.replacement = 'sfw, safe';
                            
                            app.filterManager.setMasterEnabled(true);
                            
                            const input = ['1girl', 'nsfw', 'best quality'];
                            const result = app.filterManager.applyFilter(input);
                            
                            return result.includes('1girl') && 
                                   result.includes('sfw') && 
                                   result.includes('safe') && 
                                   result.includes('best quality') &&
                                   !result.includes('nsfw');
                        }
                    },
                    {
                        name: 'å¤šç»„é¡ºåºå¤„ç†',
                        description: 'éªŒè¯å¤šç»„æŒ‰é¡ºåºæ‰§è¡Œ',
                        test: async () => {
                            const app = await getAppInstance();
                            
                            app.filterManager.groups = [];
                            
                            // ç¬¬ä¸€ç»„ï¼šnsfw -> sfw
                            const group1 = app.filterManager.addGroup('ç»„1');
                            group1.keywords = ['nsfw'];
                            group1.replacement = 'sfw';
                            
                            // ç¬¬äºŒç»„ï¼šsfw -> safe
                            const group2 = app.filterManager.addGroup('ç»„2');
                            group2.keywords = ['sfw'];
                            group2.replacement = 'safe';
                            
                            app.filterManager.setMasterEnabled(true);
                            
                            const input = ['1girl', 'nsfw'];
                            const result = app.filterManager.applyFilter(input);
                            
                            return result.includes('1girl') && 
                                   result.includes('safe') &&
                                   !result.includes('nsfw') && 
                                   !result.includes('sfw');
                        }
                    },
                    {
                        name: 'æ­£åˆ™è¡¨è¾¾å¼æ”¯æŒ',
                        description: 'éªŒè¯æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…åŠŸèƒ½',
                        test: async () => {
                            const app = await getAppInstance();
                            
                            app.filterManager.groups = [];
                            const testGroup = app.filterManager.addGroup('æ­£åˆ™æµ‹è¯•');
                            testGroup.keywords = ['\\d+px', 'bad.*quality'];
                            
                            app.filterManager.setMasterEnabled(true);
                            
                            const input = ['1girl', '1024px', 'bad quality', 'masterpiece'];
                            const result = app.filterManager.applyFilter(input);
                            
                            return result.includes('1girl') && 
                                   result.includes('masterpiece') &&
                                   !result.includes('1024px') && 
                                   !result.includes('bad quality');
                        }
                    },
                    {
                        name: 'å‘½ä¸­è®¡æ•°ç»Ÿè®¡',
                        description: 'éªŒè¯å‘½ä¸­è®¡æ•°æ­£ç¡®è®°å½•',
                        test: async () => {
                            const app = await getAppInstance();
                            
                            app.filterManager.groups = [];
                            const testGroup = app.filterManager.addGroup('è®¡æ•°æµ‹è¯•');
                            testGroup.keywords = ['test'];
                            
                            app.filterManager.setMasterEnabled(true);
                            
                            const input = ['test', '1girl', 'test', 'quality'];
                            app.filterManager.applyFilter(input);
                            
                            return testGroup.meta.lastMatchCount === 2;
                        }
                    }
                ]
            },
            simplification: {
                name: 'æç¤ºè¯ç®€åŒ–æµ‹è¯•',
                tests: [
                    {
                        name: 'ç®€åŒ–åŠŸèƒ½å¼€å…³',
                        description: 'éªŒè¯ç®€åŒ–åŠŸèƒ½å¼€å…³æ§åˆ¶',
                        test: async () => {
                            const app = await getAppInstance();
                            
                            app.filterManager.setMasterEnabled(true);
                            app.filterManager.setSimplifyEnabled(true);
                            
                            const input = ['hat', 'red hat', 'girl', 'beautiful girl'];
                            const result = app.filterManager.applyFilter(input);
                            
                            return result.includes('red hat') && 
                                   result.includes('beautiful girl') &&
                                   !result.includes('hat') && 
                                   !result.includes('girl');
                        }
                    },
                    {
                        name: 'ç®€åŒ–ç»Ÿè®¡è®¡æ•°',
                        description: 'éªŒè¯ç®€åŒ–ç§»é™¤è®¡æ•°æ­£ç¡®',
                        test: async () => {
                            const app = await getAppInstance();
                            
                            app.filterManager.setMasterEnabled(true);
                            app.filterManager.setSimplifyEnabled(true);
                            
                            const input = ['hat', 'red hat', 'girl', 'beautiful girl', 'quality', 'best quality'];
                            app.filterManager.applyFilter(input);
                            
                            return app.filterManager.lastSimplifiedCount === 3; // hat, girl, quality
                        }
                    }
                ]
            },
            importExport: {
                name: 'å¯¼å…¥å¯¼å‡ºæµ‹è¯•',
                tests: [
                    {
                        name: 'é…ç½®å¯¼å‡º',
                        description: 'éªŒè¯é…ç½®å¯¼å‡ºåŠŸèƒ½',
                        test: async () => {
                            const app = await getAppInstance();
                            
                            app.filterManager.groups = [];
                            app.filterManager.addGroup('å¯¼å‡ºæµ‹è¯•ç»„');
                            
                            const exported = app.filterManager.exportConfig();
                            const config = JSON.parse(exported);
                            
                            return config.schemaVersion === 1 && 
                                   Array.isArray(config.groups) && 
                                   config.groups.length > 0 &&
                                   config.groups[0].name === 'å¯¼å‡ºæµ‹è¯•ç»„';
                        }
                    },
                    {
                        name: 'é…ç½®å¯¼å…¥éªŒè¯',
                        description: 'éªŒè¯é…ç½®å¯¼å…¥éªŒè¯åŠŸèƒ½',
                        test: async () => {
                            const app = await getAppInstance();
                            
                            const validConfig = {
                                masterEnabled: true,
                                simplifyEnabled: false,
                                groups: [
                                    {
                                        id: 'test-id',
                                        name: 'å¯¼å…¥æµ‹è¯•',
                                        enabled: true,
                                        collapsed: true,
                                        keywords: ['test'],
                                        replacement: ''
                                    }
                                ],
                                schemaVersion: 1
                            };
                            
                            const validation = app.filterManager.validateImportConfig(validConfig);
                            return validation.valid === true;
                        }
                    },
                    {
                        name: 'é…ç½®å¯¼å…¥åº”ç”¨',
                        description: 'éªŒè¯é…ç½®å¯¼å…¥å¹¶åº”ç”¨åŠŸèƒ½',
                        test: async () => {
                            const app = await getAppInstance();
                            
                            const testConfig = {
                                masterEnabled: true,
                                simplifyEnabled: false,
                                groups: [
                                    {
                                        id: 'imported-group',
                                        name: 'å¯¼å…¥çš„ç»„',
                                        enabled: true,
                                        collapsed: true,
                                        keywords: ['imported'],
                                        replacement: 'processed'
                                    }
                                ],
                                schemaVersion: 1
                            };
                            
                            const result = app.filterManager.importConfig(JSON.stringify(testConfig), false);
                            const importedGroup = app.filterManager.groups.find(g => g.name === 'å¯¼å…¥çš„ç»„');
                            
                            return result.success && importedGroup && importedGroup.keywords.includes('imported');
                        }
                    }
                ]
            },
            validation: {
                name: 'æ•°æ®éªŒè¯æµ‹è¯•',
                tests: [
                    {
                        name: 'æ›¿æ¢çŸ­è¯­æ ¼å¼éªŒè¯',
                        description: 'éªŒè¯æ›¿æ¢çŸ­è¯­æ ¼å¼æ£€æŸ¥',
                        test: async () => {
                            const app = await getAppInstance();
                            
                            const validReplacement = 'tag1, tag2, tag3';
                            const invalidReplacement = 'tag1,tag2,tag3';
                            
                            const validResult = app.filterManager._isValidReplacement(validReplacement);
                            const invalidResult = app.filterManager._isValidReplacement(invalidReplacement);
                            
                            return validResult === true && invalidResult === false;
                        }
                    },
                    {
                        name: 'æ›¿æ¢çŸ­è¯­è§£æ',
                        description: 'éªŒè¯æ›¿æ¢çŸ­è¯­æ­£ç¡®è§£æ',
                        test: async () => {
                            const app = await getAppInstance();
                            
                            const replacement = 'tag1, tag2, tag3';
                            const parsed = app.filterManager._parseReplacementString(replacement);
                            
                            return Array.isArray(parsed) && 
                                   parsed.length === 3 && 
                                   parsed.includes('tag1') && 
                                   parsed.includes('tag2') && 
                                   parsed.includes('tag3');
                        }
                    },
                    {
                        name: 'å»é‡åŠŸèƒ½',
                        description: 'éªŒè¯æ•°ç»„å»é‡åŠŸèƒ½',
                        test: async () => {
                            const app = await getAppInstance();
                            
                            const input = ['tag1', 'tag2', 'tag1', 'tag3', 'tag2'];
                            const result = app.filterManager._dedupeKeepFirst(input);
                            
                            return result.length === 3 && 
                                   result[0] === 'tag1' && 
                                   result[1] === 'tag2' && 
                                   result[2] === 'tag3';
                        }
                    }
                ]
            },
            integration: {
                name: 'é›†æˆæµ‹è¯•',
                tests: [
                    {
                        name: 'Danbooruæ ¼å¼å®Œæ•´æµç¨‹',
                        description: 'éªŒè¯Danbooruæ ¼å¼çš„å®Œæ•´å¤„ç†æµç¨‹',
                        test: async () => {
                            const app = await getAppInstance();
                            
                            // è®¾ç½®è¿‡æ»¤ç»„
                            app.filterManager.groups = [];
                            const filterGroup = app.filterManager.addGroup('å†…å®¹è¿‡æ»¤');
                            filterGroup.keywords = ['nsfw', 'watermark'];
                            filterGroup.replacement = 'sfw';
                            
                            app.filterManager.setMasterEnabled(true);
                            app.filterManager.setSimplifyEnabled(true);
                            
                            const danbooruInput = `General
?
1girl 6.1M
long hair 3.2M
hat 1M
red hat 500K
nsfw 200K
watermark 100K`;
                            
                            // æ¨¡æ‹Ÿå®Œæ•´è½¬æ¢æµç¨‹
                            const result = app.convert(danbooruInput);
                            
                            return Array.isArray(result) && 
                                   result.includes('1girl') && 
                                   result.includes('long hair') && 
                                   result.includes('red hat') && 
                                   result.includes('sfw') && 
                                   !result.includes('hat') && // è¢«ç®€åŒ–ç§»é™¤
                                   !result.includes('nsfw') && // è¢«è¿‡æ»¤
                                   !result.includes('watermark'); // è¢«è¿‡æ»¤
                        }
                    },
                    {
                        name: 'æ€»å¼€å…³æ§åˆ¶',
                        description: 'éªŒè¯æ€»å¼€å…³å¯¹æ‰€æœ‰åŠŸèƒ½çš„æ§åˆ¶',
                        test: async () => {
                            const app = await getAppInstance();
                            
                            // è®¾ç½®è¿‡æ»¤ç»„
                            app.filterManager.groups = [];
                            const filterGroup = app.filterManager.addGroup('æµ‹è¯•ç»„');
                            filterGroup.keywords = ['test'];
                            
                            app.filterManager.setMasterEnabled(false); // å…³é—­æ€»å¼€å…³
                            app.filterManager.setSimplifyEnabled(true);
                            
                            const input = ['test', 'hat', 'red hat'];
                            const result = app.filterManager.applyFilter(input);
                            
                            // æ€»å¼€å…³å…³é—­æ—¶ï¼Œåº”è¯¥åŸæ ·è¿”å›
                            return result.length === input.length && 
                                   result.includes('test') && 
                                   result.includes('hat') && 
                                   result.includes('red hat');
                        }
                    }
                ]
            }
        };

        // å·¥å…·å‡½æ•°
        async function getAppInstance() {
            if (!testConfig.iframe) {
                testConfig.iframe = document.getElementById('app-iframe');
            }
            
            return new Promise((resolve) => {
                if (testConfig.iframe.contentWindow.tagConverter) {
                    resolve(testConfig.iframe.contentWindow);
                } else {
                    testConfig.iframe.onload = () => {
                        setTimeout(() => {
                            resolve(testConfig.iframe.contentWindow);
                        }, 100);
                    };
                }
            });
        }

        function getElement(id) {
            return testConfig.iframe.contentDocument.getElementById(id);
        }

        async function simulateUIUpdate(app) {
            // æ¨¡æ‹ŸUIæ›´æ–°
            if (app.initializeGroupedFilterUI) {
                app.initializeGroupedFilterUI();
            }
            await new Promise(resolve => setTimeout(resolve, 50));
        }

        // æµ‹è¯•æ‰§è¡Œå‡½æ•°
        async function runTestSuite(suiteName) {
            const suite = testSuites[suiteName];
            if (!suite) return;

            const sectionDiv = createTestSection(suite.name);
            
            for (const testCase of suite.tests) {
                const caseDiv = createTestCase(testCase.name, testCase.description);
                sectionDiv.appendChild(caseDiv);
                
                testConfig.currentTest++;
                updateProgress();
                
                try {
                    caseDiv.className += ' running';
                    const result = await testCase.test();
                    
                    if (result) {
                        caseDiv.className = caseDiv.className.replace(' running', ' passed');
                        testConfig.passedTests++;
                        
                        const output = document.createElement('div');
                        output.className = 'test-output';
                        output.textContent = 'âœ… æµ‹è¯•é€šè¿‡';
                        caseDiv.appendChild(output);
                    } else {
                        throw new Error('æµ‹è¯•æ¡ä»¶ä¸æ»¡è¶³');
                    }
                } catch (error) {
                    caseDiv.className = caseDiv.className.replace(' running', ' failed');
                    testConfig.failedTests++;
                    
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'test-error';
                    errorDiv.textContent = `âŒ ${error.message}`;
                    caseDiv.appendChild(errorDiv);
                }
                
                testConfig.testResults.push({
                    suite: suite.name,
                    test: testCase.name,
                    passed: caseDiv.classList.contains('passed'),
                    error: caseDiv.classList.contains('failed') ? caseDiv.querySelector('.test-error')?.textContent : null
                });
                
                updateStats();
                await new Promise(resolve => setTimeout(resolve, 100)); // çŸ­æš‚å»¶è¿Ÿ
            }
        }

        function createTestSection(name) {
            const sectionsContainer = document.getElementById('test-sections');
            
            const section = document.createElement('div');
            section.className = 'test-section';
            section.innerHTML = `<h3>${name}</h3>`;
            
            sectionsContainer.appendChild(section);
            return section;
        }

        function createTestCase(name, description) {
            const caseDiv = document.createElement('div');
            caseDiv.className = 'test-case';
            
            const header = document.createElement('h4');
            header.textContent = name;
            caseDiv.appendChild(header);
            
            const desc = document.createElement('div');
            desc.className = 'test-description';
            desc.textContent = description;
            caseDiv.appendChild(desc);
            
            return caseDiv;
        }

        function updateStats() {
            document.getElementById('total-tests').textContent = testConfig.currentTest;
            document.getElementById('passed-tests').textContent = testConfig.passedTests;
            document.getElementById('failed-tests').textContent = testConfig.failedTests;
            
            const successRate = testConfig.currentTest > 0 
                ? Math.round((testConfig.passedTests / testConfig.currentTest) * 100)
                : 0;
            document.getElementById('success-rate').textContent = successRate + '%';
        }

        function updateProgress() {
            const totalTests = Object.values(testSuites).reduce((sum, suite) => sum + suite.tests.length, 0);
            const progress = (testConfig.currentTest / totalTests) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
        }

        function updateOverallStatus(status) {
            const statusEl = document.getElementById('overall-status');
            statusEl.textContent = status;
            statusEl.className = `status-badge status-${status.toLowerCase().replace(/\s+/g, '-')}`;
        }

        // ä¸»è¦æµ‹è¯•å‡½æ•°
        async function runAllTests() {
            initializeTest();
            updateOverallStatus('è¿è¡Œä¸­');
            
            try {
                await runTestSuite('basic');
                await runTestSuite('groupManagement');
                await runTestSuite('filterAlgorithm');
                await runTestSuite('simplification');
                await runTestSuite('importExport');
                await runTestSuite('validation');
                await runTestSuite('integration');
                
                const success = testConfig.failedTests === 0;
                updateOverallStatus(success ? 'å…¨éƒ¨é€šè¿‡' : 'éƒ¨åˆ†å¤±è´¥');
                
                showCompletionMessage();
            } catch (error) {
                updateOverallStatus('è¿è¡Œå¤±è´¥');
                console.error('æµ‹è¯•è¿è¡Œå‡ºé”™:', error);
            }
        }

        async function runBasicTests() {
            initializeTest();
            updateOverallStatus('è¿è¡Œä¸­');
            await runTestSuite('basic');
            await runTestSuite('groupManagement');
            updateOverallStatus(testConfig.failedTests === 0 ? 'åŸºç¡€æµ‹è¯•é€šè¿‡' : 'åŸºç¡€æµ‹è¯•å¤±è´¥');
        }

        async function runAdvancedTests() {
            initializeTest();
            updateOverallStatus('è¿è¡Œä¸­');
            await runTestSuite('filterAlgorithm');
            await runTestSuite('simplification');
            await runTestSuite('importExport');
            updateOverallStatus(testConfig.failedTests === 0 ? 'é«˜çº§æµ‹è¯•é€šè¿‡' : 'é«˜çº§æµ‹è¯•å¤±è´¥');
        }

        async function runUITests() {
            initializeTest();
            updateOverallStatus('è¿è¡Œä¸­');
            await runTestSuite('validation');
            await runTestSuite('integration');
            updateOverallStatus(testConfig.failedTests === 0 ? 'UIæµ‹è¯•é€šè¿‡' : 'UIæµ‹è¯•å¤±è´¥');
        }

        function initializeTest() {
            testConfig.totalTests = 0;
            testConfig.passedTests = 0;
            testConfig.failedTests = 0;
            testConfig.currentTest = 0;
            testConfig.testResults = [];
            testConfig.startTime = Date.now();
            
            document.getElementById('test-sections').innerHTML = '';
            updateStats();
            updateProgress();
        }

        function clearAllTests() {
            initializeTest();
            updateOverallStatus('å‡†å¤‡ä¸­');
        }

        function showCompletionMessage() {
            const duration = Date.now() - testConfig.startTime;
            const message = `
æµ‹è¯•å®Œæˆï¼
æ€»è€—æ—¶: ${(duration / 1000).toFixed(2)}ç§’
é€šè¿‡ç‡: ${Math.round((testConfig.passedTests / testConfig.currentTest) * 100)}%
            `.trim();
            
            alert(message);
        }

        function exportResults() {
            const report = {
                timestamp: new Date().toISOString(),
                duration: testConfig.startTime ? Date.now() - testConfig.startTime : 0,
                summary: {
                    total: testConfig.currentTest,
                    passed: testConfig.passedTests,
                    failed: testConfig.failedTests,
                    successRate: Math.round((testConfig.passedTests / testConfig.currentTest) * 100)
                },
                results: testConfig.testResults
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `test-report-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('æµ‹è¯•é¡µé¢å·²åŠ è½½');
            
            // è®¡ç®—æ€»æµ‹è¯•æ•°
            const totalTests = Object.values(testSuites).reduce((sum, suite) => sum + suite.tests.length, 0);
            console.log(`æ€»å…± ${totalTests} ä¸ªæµ‹è¯•ç”¨ä¾‹`);
        });
    </script>
</body>
</html>