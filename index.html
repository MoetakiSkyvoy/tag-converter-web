<!-- index.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tag格式转换器 - 支持Danbooru/Gelbooru多格式转换</title>
    <meta name="description" content="智能Tag格式转换器，支持Danbooru和Gelbooru格式自动识别和转换，实时处理，一键复制">
    <meta name="keywords" content="Tag转换器,Danbooru,Gelbooru,提示词,AI绘图">
    
    <style>
        /* =================================
           基础样式与布局
           ================================= */
        
        /* 全局字体和布局设置 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
            line-height: 1.6;
            color: #333;
            background-color: #fafafa;
        }
        
        /* 主容器样式 */
        .container {
            background: #ffffff;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s ease;
        }
        
        .container:hover {
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }
        
        /* 标题样式 */
        h1 {
            text-align: center;
            color: #1d1d1f;
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-size: 2.2rem;
        }
        
        .subtitle {
            text-align: center;
            color: #86868b;
            font-size: 1rem;
            margin-bottom: 2rem;
        }
        
        /* =================================
           输入输出区域样式
           ================================= */
        
        /* 输入文本框样式 */
        .input-section {
            margin-bottom: 1.5rem;
        }
        
        .input-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1d1d1f;
        }
        
        textarea {
            width: 100%;
            height: 300px;
            padding: 16px;
            border: 2px solid #e5e5e7;
            border-radius: 12px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }
        
        textarea:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        /* 按钮组样式 */
        .button-group {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            min-width: 120px;
        }
        
        button:hover {
            background: #0056CC;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.secondary {
            background: #f2f2f7;
            color: #1d1d1f;
        }
        
        button.secondary:hover {
            background: #e5e5ea;
        }
        
        /* 输出区域样式 */
        .output-section {
            margin-top: 1.5rem;
        }
        
        .output-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1d1d1f;
        }
        
        #output {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 16px;
            min-height: 100px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #495057;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        #output.has-content {
            background: #e8f5e8;
            border-color: #28a745;
            color: #155724;
            text-align: left;
            justify-content: flex-start;
        }
        
        /* 状态指示器 */
        .status-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .status-indicator.detected {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        /* =================================
           响应式设计
           ================================= */
        
        @media (max-width: 768px) {
            body {
                margin: 1rem auto;
                padding: 0 0.5rem;
            }
            
            .container {
                padding: 1.5rem;
                border-radius: 12px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            textarea {
                height: 250px;
                padding: 12px;
            }
            
            .button-group {
                flex-direction: column;
                align-items: center;
            }
            
            button {
                width: 100%;
                max-width: 200px;
            }
        }
        
        /* =================================
           工具提示和动画
           ================================= */
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
        }
        
        /* 加载动画 */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #ccc;
            border-top: 2px solid #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 页面标题区域 -->
        <header>
            <h1>Tag格式转换器</h1>
            <p class="subtitle">支持Danbooru、Gelbooru多格式智能转换、实时处理和一键复制</p>
        </header>
        
        <!-- 输入区域 -->
        <section class="input-section">
            <label for="input" class="input-label">输入原始Tag文本</label>
            <textarea 
                id="input" 
                placeholder="请粘贴来自Danbooru或Gelbooru的原始tag文本...&#10;&#10;支持格式：&#10;• Danbooru: 换行符+?标记格式&#10;• Gelbooru: Artist?/Tag?连续格式&#10;• Standard: 逗号分隔标准格式"
                aria-describedby="input-help"></textarea>
            <div id="format-status" class="status-indicator" style="display: none;"></div>
        </section>
        
        <!-- 操作按钮组 -->
        <section class="button-group">
            <button 
                onclick="loadExample()" 
                class="secondary tooltip" 
                data-tooltip="加载Danbooru格式示例数据">
                📝 加载示例
            </button>
            <button 
                onclick="clearAll()" 
                class="secondary tooltip" 
                data-tooltip="清空输入和输出内容">
                🗑️ 清空内容
            </button>
            <button 
                onclick="copyOutput(this)" 
                class="tooltip" 
                data-tooltip="复制转换结果到剪贴板">
                📋 复制结果
            </button>
        </section>
        
        <!-- 输出区域 -->
        <section class="output-section">
            <label for="output" class="output-label">转换结果</label>
            <div 
                id="output" 
                aria-live="polite" 
                aria-label="转换结果输出区域">等待输入内容进行转换...
            </div>
        </section>
    </div>

    <script>
        /**
         * ====================================================================
         * Tag格式转换器 - 统一处理算法
         * ====================================================================
         * 
         * 功能概述：
         * - 支持Danbooru、Gelbooru、Standard三种格式的智能识别和转换
         * - 采用三阶段处理流程：格式检测 → 内容提取 → 统一清理
         * - 保护词组完整性，防止复合词组被错误分割
         * - 实时转换，用户体验友好
         * 
         * 架构设计：
         * - TagConverter: 主控制器类
         * - FormatDetector: 格式检测模块
         * - ContentExtractor: 内容提取模块  
         * - ContentCleaner: 内容清理模块
         * - UIManager: 用户界面管理模块
         */

        // ====================================================================
        // 常量定义和配置
        // ====================================================================
        
        const CONFIG = {
            // 支持的格式类型
            FORMATS: {
                DANBOORU: 'danbooru',    // Danbooru格式：换行符+?标记
                GELBOORU: 'gelbooru',    // Gelbooru格式：Artist?/Tag?连续格式  
                STANDARD: 'standard'     // 标准格式：逗号分隔
            },
            
            // 分类标识符定义
            CATEGORY_MARKERS: ['Artist', 'Character', 'Copyright', 'Tag', 'Metadata', 'General'],
            
            // 正则表达式模式
            PATTERNS: {
                GELBOORU_MARKERS: /(?:Artist|Character|Copyright|Tag|Metadata)\?/i,
                CATEGORY_CONTENT: /^(Artist|Character|Copyright|Metadata|Tag)\s+(.*)$/,
                WEIGHT_REMOVAL: /\s+\d+\.?\d*[kM]?\s*$/,
                GELBOORU_WEIGHT: /\s+\d+\s*(Artist|Character|Copyright|Metadata|Tag)?.*$/,
                NORMALIZE_SPACES: /\s+/g
            },
            
            // UI相关配置
            UI: {
                COPY_SUCCESS_DURATION: 1500,
                COPY_SUCCESS_COLOR: '#34C759',
                DEFAULT_BUTTON_COLOR: '#007AFF'
            }
        };

        // ====================================================================
        // 核心处理类：Tag转换器
        // ====================================================================
        
        class TagConverter {
            constructor() {
                this.formatDetector = new FormatDetector();
                this.contentExtractor = new ContentExtractor();
                this.contentCleaner = new ContentCleaner();
                this.uiManager = new UIManager();
            }
            
            /**
             * 主转换方法
             * @param {string} input - 输入的原始文本
             * @returns {string[]} - 处理后的tag数组
             */
            convert(input) {
                if (!input || typeof input !== 'string') {
                    return [];
                }
                
                try {
                    // 三阶段处理流程
                    const format = this.formatDetector.detect(input.trim());
                    const rawContent = this.contentExtractor.extract(input.trim(), format);
                    const cleanedTags = this.contentCleaner.clean(rawContent);
                    
                    // 更新UI状态
                    this.uiManager.updateFormatStatus(format, cleanedTags.length);
                    
                    return cleanedTags;
                } catch (error) {
                    console.error('转换过程中发生错误:', error);
                    this.uiManager.showError('转换失败，请检查输入格式');
                    return [];
                }
            }
        }

        // ====================================================================
        // 格式检测模块
        // ====================================================================
        
        class FormatDetector {
            /**
             * 检测输入文本的格式类型
             * @param {string} input - 输入文本
             * @returns {string} - 格式类型（danbooru/gelbooru/standard）
             */
            detect(input) {
                const hasNewlines = input.includes('\n');
                const hasGelbooruMarkers = CONFIG.PATTERNS.GELBOORU_MARKERS.test(input);
                const hasQuestionMarks = input.includes('?');
                
                // 格式判断逻辑
                if (!hasNewlines && hasGelbooruMarkers) {
                    return CONFIG.FORMATS.GELBOORU;
                }
                
                if (hasNewlines && hasQuestionMarks) {
                    return CONFIG.FORMATS.DANBOORU;
                }
                
                if (!hasNewlines && hasQuestionMarks) {
                    return CONFIG.FORMATS.GELBOORU; // 单行带?的也被视为Gelbooru
                }
                
                return CONFIG.FORMATS.STANDARD; // 默认为标准格式
            }
        }

        // ====================================================================
        // 内容提取模块
        // ====================================================================
        
        class ContentExtractor {
            /**
             * 根据格式类型提取原始内容
             * @param {string} input - 输入文本
             * @param {string} format - 格式类型
             * @returns {string} - 提取的原始内容
             */
            extract(input, format) {
                switch (format) {
                    case CONFIG.FORMATS.DANBOORU:
                        return this.extractDanbooru(input);
                    case CONFIG.FORMATS.GELBOORU:
                        return this.extractGelbooru(input);
                    case CONFIG.FORMATS.STANDARD:
                    default:
                        return input; // 标准格式直接返回
                }
            }
            
            /**
             * 提取Danbooru格式内容
             * @param {string} input - Danbooru格式输入
             * @returns {string} - 提取的内容
             */
            extractDanbooru(input) {
                const lines = input.split('\n').map(line => line.trim());
                const contents = [];
                
                for (let i = 0; i < lines.length; i++) {
                    // 找到?标记行，提取下一行内容
                    if (lines[i] === '?' && i + 1 < lines.length) {
                        contents.push(lines[i + 1]);
                        i++; // 跳过已处理的下一行
                    }
                }
                
                return contents.join(', '); // 用逗号连接保持结构
            }
            
            /**
             * 提取Gelbooru格式内容
             * @param {string} input - Gelbooru格式输入
             * @returns {string} - 提取的内容
             */
            extractGelbooru(input) {
                const segments = input.split('?');
                const processedSegments = [];
                
                for (const segment of segments) {
                    const trimmedSegment = segment.trim();
                    if (!trimmedSegment) continue;
                    
                    const processedContent = this.processGelbooruSegment(trimmedSegment);
                    if (processedContent) {
                        processedSegments.push(processedContent);
                    }
                }
                
                return processedSegments.join(', ');
            }
            
            /**
             * 处理单个Gelbooru段落
             * @param {string} segment - 单个段落
             * @returns {string|null} - 处理后的内容或null
             */
            processGelbooruSegment(segment) {
                // 检查是否以分类标识符开头
                const categoryMatch = segment.match(CONFIG.PATTERNS.CATEGORY_CONTENT);
                
                if (categoryMatch) {
                    // 提取分类标识符后面的内容
                    let content = categoryMatch[2];
                    // 移除末尾数字和可能的下一个分类标识符
                    content = content.replace(CONFIG.PATTERNS.GELBOORU_WEIGHT, '').trim();
                    return content || null;
                } else {
                    // 普通内容，移除末尾数字
                    const cleaned = segment.replace(/\s+\d+.*$/, '').trim();
                    return (cleaned && cleaned.length > 1) ? cleaned : null;
                }
            }
        }

        // ====================================================================
        // 内容清理模块
        // ====================================================================
        
        class ContentCleaner {
            /**
             * 清理和标准化内容
             * @param {string} rawText - 原始文本内容
             * @returns {string[]} - 清理后的tag数组
             */
            clean(rawText) {
                if (!rawText) return [];
                
                // 按逗号分割并清理每个片段
                const segments = rawText.split(',').map(segment => segment.trim());
                const cleanedTags = [];
                
                for (const segment of segments) {
                    const cleanedTag = this.cleanSingleTag(segment);
                    if (cleanedTag) {
                        cleanedTags.push(cleanedTag);
                    }
                }
                
                return this.removeDuplicates(cleanedTags);
            }
            
            /**
             * 清理单个tag
             * @param {string} tag - 单个tag
             * @returns {string|null} - 清理后的tag或null
             */
            cleanSingleTag(tag) {
                if (!tag) return null;
                
                // 跳过纯分类标识符
                if (this.isPureCategoryWord(tag)) {
                    return null;
                }
                
                // 移除末尾的数字权重
                let cleaned = tag.replace(CONFIG.PATTERNS.WEIGHT_REMOVAL, '').trim();
                
                // 标准化空格
                cleaned = cleaned.replace(CONFIG.PATTERNS.NORMALIZE_SPACES, ' ').trim();
                
                // 验证有效性
                return (cleaned && cleaned.length > 0) ? cleaned : null;
            }
            
            /**
             * 检查是否为纯分类标识符
             * @param {string} tag - 待检查的tag
             * @returns {boolean} - 是否为分类标识符
             */
            isPureCategoryWord(tag) {
                return CONFIG.CATEGORY_MARKERS.some(
                    word => word.toLowerCase() === tag.toLowerCase()
                );
            }
            
            /**
             * 移除重复的tag
             * @param {string[]} tags - tag数组
             * @returns {string[]} - 去重后的tag数组
             */
            removeDuplicates(tags) {
                const seen = new Set();
                return tags.filter(tag => {
                    const lowerTag = tag.toLowerCase();
                    if (seen.has(lowerTag)) {
                        return false;
                    }
                    seen.add(lowerTag);
                    return true;
                });
            }
        }

        // ====================================================================
        // 用户界面管理模块
        // ====================================================================
        
        class UIManager {
            constructor() {
                this.elements = {
                    input: document.getElementById('input'),
                    output: document.getElementById('output'),
                    formatStatus: document.getElementById('format-status')
                };
            }
            
            /**
             * 更新格式状态显示
             * @param {string} format - 检测到的格式
             * @param {number} tagCount - tag数量
             */
            updateFormatStatus(format, tagCount) {
                const statusEl = this.elements.formatStatus;
                if (!statusEl) return;
                
                const formatNames = {
                    [CONFIG.FORMATS.DANBOORU]: 'Danbooru',
                    [CONFIG.FORMATS.GELBOORU]: 'Gelbooru', 
                    [CONFIG.FORMATS.STANDARD]: 'Standard'
                };
                
                statusEl.textContent = `检测格式: ${formatNames[format]}，提取Tags: ${tagCount}个`;
                statusEl.className = 'status-indicator detected';
                statusEl.style.display = 'inline-block';
            }
            
            /**
             * 显示错误信息
             * @param {string} message - 错误信息
             */
            showError(message) {
                const outputEl = this.elements.output;
                if (outputEl) {
                    outputEl.textContent = `⚠️ ${message}`;
                    outputEl.className = '';
                }
            }
            
            /**
             * 更新输出内容
             * @param {string[]} tags - tag数组
             */
            updateOutput(tags) {
                const outputEl = this.elements.output;
                if (!outputEl) return;
                
                if (tags.length === 0) {
                    outputEl.textContent = '等待输入内容进行转换...';
                    outputEl.className = '';
                } else {
                    outputEl.textContent = tags.join(', ');
                    outputEl.className = 'has-content';
                }
            }
            
            /**
             * 显示复制成功反馈
             * @param {HTMLElement} button - 复制按钮元素
             */
            showCopySuccess(button) {
                const originalText = button.textContent;
                const originalColor = button.style.background;
                
                button.textContent = '✅ 已复制';
                button.style.background = CONFIG.UI.COPY_SUCCESS_COLOR;
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = originalColor || CONFIG.UI.DEFAULT_BUTTON_COLOR;
                }, CONFIG.UI.COPY_SUCCESS_DURATION);
            }
        }

        // ====================================================================
        // 全局实例和主要功能函数
        // ====================================================================
        
        // 创建全局转换器实例
        const tagConverter = new TagConverter();
        
        /**
         * 主转换函数 - 供UI调用
         */
        function convert() {
            const input = document.getElementById('input').value.trim();
            const tags = tagConverter.convert(input);
            tagConverter.uiManager.updateOutput(tags);
        }
        
        /**
         * 复制输出结果到剪贴板
         * @param {HTMLElement} button - 触发的按钮元素
         */
        function copyOutput(button) {
            const output = document.getElementById('output');
            const content = output.textContent.trim();
            
            if (!content || content === '等待输入内容进行转换...') {
                alert('没有可复制的内容');
                return;
            }
            
            navigator.clipboard.writeText(content)
                .then(() => {
                    tagConverter.uiManager.showCopySuccess(button);
                })
                .catch(err => {
                    console.error('复制失败:', err);
                    alert('复制失败，请手动选择复制');
                });
        }
        
        /**
         * 加载示例数据
         */
        function loadExample() {
            const examples = [
                // Danbooru格式示例
                `General\n?\n1boy 1.4M\n?\n1girl 6.1M\n?\noriginal 2.8M`,
                // Gelbooru格式示例  
                `Artist? nekotokage 169Character? shirayuki tomoe 939Tag? 1girl 8032615? long hair 5441398? smile 3596391`,
                // 标准格式示例
                `masterpiece, best quality, 1girl, long hair, blue eyes, school uniform`
            ];
            
            const randomExample = examples[Math.floor(Math.random() * examples.length)];
            document.getElementById('input').value = randomExample;
            convert();
        }
        
        /**
         * 清空所有内容
         */
        function clearAll() {
            document.getElementById('input').value = '';
            document.getElementById('output').textContent = '等待输入内容进行转换...';
            document.getElementById('output').className = '';
            
            const statusEl = document.getElementById('format-status');
            if (statusEl) {
                statusEl.style.display = 'none';
            }
        }

        // ====================================================================
        // 事件监听器和初始化
        // ====================================================================
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 实时转换监听
            document.getElementById('input').addEventListener('input', convert);
            
            // 键盘快捷键支持
            document.addEventListener('keydown', function(e) {
                // Ctrl+Enter 或 Cmd+Enter 复制结果
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    const copyBtn = document.querySelector('button[onclick*="copyOutput"]');
                    if (copyBtn) copyOutput(copyBtn);
                }
                
                // Ctrl+L 或 Cmd+L 加载示例
                if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
                    e.preventDefault();
                    loadExample();
                }
            });
            
            console.log('Tag格式转换器已初始化 - 支持Danbooru/Gelbooru/Standard格式');
        });
    </script>
</body>
</html>