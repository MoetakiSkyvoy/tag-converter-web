# 自定义过滤器（分组版）规范 v1.0

> 文档目的：将“自定义过滤器”扩展为**可分组**的规则系统，形成可实现、可测试、可维护的统一规范。
>
> 文档基线：以《自定义过滤器（分组版）— 交互草图（Wireframe v1）》的**最新状态**为准，并严格复用现有源码的**关键词匹配规则**与处理顺序。

- **文档版本**：v1.0
- **日期**：2025-08-09
- **适用范围**：单页应用（纯前端）

---

## 1. 名词与术语

- **自定义过滤器（总开关）**：该模块的总运行开关；关闭时**运行禁用但仍可编辑**。
- **组（Group）**：一条可命名、可启用/停用、可折叠、可拖拽排序的过滤规则。
- **关键词（Keywords）**：用于匹配并移除的标签集合（每条视为一个匹配项，允许正则，语义遵循现有源码）。
- **替换短语（Replacement）**：当本组有命中时，插入到**首次命中的关键词原位置**；为空则仅删除。
- **提示词列表（Tokens）**：格式化阶段产出的标签序列，是本模块的输入与输出对象。
- **命中计数徽标**：显示“上一次运行时该组命中的 token 数量”。
- **提示词简化**：与分组过滤并列的子模块，**位于自定义过滤器模块末尾**并在其后执行。

---

## 2. 范围与目标

- 支持**分组管理**（新增/复制/删除/启用/折叠/拖拽排序/命名）。
- 支持**组替换**（严格仅接受`, `分隔的多标签替换；空则只删除）。
- **执行与优先级**：自上而下、单轮执行；**分组过滤 → 提示词简化**；总开关=关时跳过执行但允许编辑。
- **一致性**：匹配逻辑**完全复用现有源码的编译与测试流程**（正则支持、大小写不敏、默认边界、无效正则降级等）。
- 提供**导入/导出**配置与**命中计数**展示。

---

## 3. 用户故事（摘要）

1. 我可以把多个关键词归为一组，并为这组设置一个替换短语（可留空）。
2. 我可以拖拽组改变执行顺序，或快速停用单个组进行对比。
3. 我可以导出当前所有组配置，与他人共享或备份；也可以导入他人配置。
4. 当总开关关闭时，我仍可继续配置与排序，待开启后立即生效。
5. 运行后，我能看到每组**上次命中的数量**，用来检验规则有效性。

---

## 4. 功能规格

### 4.1 组管理

- **新增组**：默认名称“组 n”，默认 `enabled=true`，`collapsed=true`。
- **复制组**：克隆关键词、替换短语与启用状态；组名加“(副本)”。
- **删除组**：二次确认；删除后不可恢复。
- **启用/停用**：仅影响本组；当总开关=关时，切换不生效但允许操作（UI 提示）。
- **折叠/展开**：默认折叠；进入编辑时展开。
- **拖拽排序**：通过☰手柄拖拽；完成后即更新执行顺序。

### 4.2 匹配与替换

- **匹配规则**：**严格复用现有源码**（以下仅做结果性描述）：
  - 每个关键词按源码的“编译→匹配”流程处理；
  - 支持正则表达式与大小写不敏；
  - 对普通字符串应用源码默认的**边界处理**（如 ^ / \$ / \b 等由源码决定）；
  - **无效正则**需按源码降级为普通字符串匹配（自动转义）。
- **命中处理**（单组）：
  1. 记录本组命中的所有 token 索引集合 `matches`；
  2. 删除 `matches` 中的全部 token；
  3. 若 `replacement` 非空：将其按 ``**（逗号+空格）** 拆分为 `replTokens`，并**按序**插入到 `min(matches)` 位置；
  4. **全局去重**：保留靠前（先出现者优先）。
- **多组协作**：后续组在前一组输出上继续匹配；**单轮、不回溯**（避免循环替换）。

### 4.3 替换短语输入规则

- **语法**：仅允许用 ``**（逗号+空格）** 分隔多个标签；留空表示仅删除。
- **校验**：
  - 若存在 `,` 但不含 `, `（逗号后无空格），显示**错误**提示；
  - 运行期：当存在校验错误时，该组\*\*按“仅删除”\*\*处理，同时在 UI 以 `role=alert` 提示用户纠正；
  - 允许首尾空格；空片段（如结尾多一个逗号）被忽略。

### 4.4 总开关行为

- **关**：跳过“分组过滤”和“提示词简化”的执行；
  - UI：模块置灰并显示“运行已禁用（可编辑）”；
  - 允许编辑组、导入导出、拖拽排序；
  - 命中计数徽标显示为“—”。
- **开**：正常执行；顶部统计显示总命中数与简化移除数。

### 4.5 与“提示词简化”的关系

- 执行顺序：**分组过滤 → 提示词简化**；
- UI：简化子卡片位于自定义过滤器模块末尾，受总开关连带置灰；
- 数据：简化不写入组配置。

### 4.6 导入/导出

- **导出**：生成 JSON，包含 `schemaVersion` 与 `exportedAt`（ISO 时间）。
- **导入**：
  - 校验 `schemaVersion` 与结构；必要时字段迁移（如新增 `collapsed` 默认 `true`）；
  - 支持**覆盖导入**与**追加导入**；
  - 导入前显示预览（将导入的组数、名称列表）；
  - 解析失败或结构不符给出错误提示。

### 4.7 命中计数徽标

- **统计点**：每次执行完成后，记录每组的命中数量到 `lastMatchCount`（非核心 schema，可放 `meta`）。
- **展示**：
  - 折叠态：右侧圆点徽标 `•N`；
  - 展开态：标题处“命中 •N”；
  - 总开关=关：显示“—”。
- **清零**：⋯ 菜单提供“清零命中计数”（仅清该字段）。

---

## 5. 数据模型

### 5.1 TypeScript 结构

```ts
export type Group = {
  id: string;           // 稳定 ID（UUID）
  name: string;         // 组名（默认“组 n”）
  enabled: boolean;     // 是否启用
  collapsed: boolean;   // 折叠状态（默认 true）
  keywords: string[];   // 关键词原始文本数组（逐项按源码编译匹配）
  replacement: string;  // 替换短语的原始输入（用“, ”分隔）
  meta?: {
    lastMatchCount?: number; // 上次命中数（可选）
  };
};

export type FilterConfig = {
  masterEnabled: boolean; // 自定义过滤器总开关
  groups: Group[];        // 有序数组（执行顺序）
  schemaVersion: number;  // Schema 版本
};
```

### 5.2 JSON Schema（导入/导出）

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "FilterConfig",
  "type": "object",
  "required": ["masterEnabled", "groups", "schemaVersion"],
  "properties": {
    "masterEnabled": {"type": "boolean"},
    "schemaVersion": {"type": "integer", "minimum": 1},
    "groups": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["id", "name", "enabled", "collapsed", "keywords", "replacement"],
        "properties": {
          "id": {"type": "string", "minLength": 1},
          "name": {"type": "string"},
          "enabled": {"type": "boolean"},
          "collapsed": {"type": "boolean"},
          "keywords": {"type": "array", "items": {"type": "string"}},
          "replacement": {"type": "string"},
          "meta": {
            "type": "object",
            "properties": {
              "lastMatchCount": {"type": "integer", "minimum": 0}
            },
            "additionalProperties": true
          }
        },
        "additionalProperties": false
      }
    },
    "exportedAt": {"type": "string"}
  },
  "additionalProperties": false
}
```

---

## 6. 执行流程与算法

### 6.1 执行时机

- 继续沿用现有管线：`格式检测 → 内容提取 → 统一清理` **→ 分组过滤（本模块） → 提示词简化 → 输出/复制**。

### 6.2 伪代码

```txt
function applyGroupedFilters(tokens, config):
  if (!config.masterEnabled):
    return tokens // 运行禁用但可编辑

  for group in config.groups:
    if (!group.enabled):
      continue

    matches = indices where token matches ANY group.keywords // 按源码编译与匹配
    if (matches is empty):
      group.meta.lastMatchCount = 0
      continue

    group.meta.lastMatchCount = len(matches)

    // 删除命中
    remove tokens at matches

    // 处理替换短语
    if (isValidReplacement(group.replacement)):
      replTokens = splitByCommaSpace(group.replacement) // 仅按", "拆分
      insert replTokens at index = min(matches)
    else:
      // 有逗号但分隔符错误：仅删除，并提示用户
      alertGroupSeparatorError(group)

    // 全局去重（保留靠前）
    tokens = dedupeKeepFirst(tokens)

  return tokens
```

### 6.3 校验 & 解析

- `isValidReplacement(s)`：
  - 若字符串中包含 `,` 且不存在 `, `，返回 false；
  - 否则返回 true；
- `splitByCommaSpace(s)`：
  - `s.trim().split(', ')`；过滤空片段；
  - 输出数组用于插入。

---

## 7. UI/交互规范

### 7.1 顶部工具区

- 控件：`[展开/收起设置] [总开关] [新增组] [导入] [导出]`。
- 统计条：`过滤规则 N｜上次过滤 X（总命中）｜简化移除 Y`。

### 7.2 组卡片

- **折叠态**：☰ 拖拽手柄｜启用开关｜组名输入｜命中计数徽标（•N/—）｜展开按钮｜⋯ 菜单（复制/删除）。
- **展开态**：关键词编辑器（多标签/批量粘贴逗号拆分/正则提示）、替换短语输入（严格`, `）、说明与警示区、收起按钮。

### 7.3 空/错误状态

- 无组：空状态提示与“新增组”按钮。
- 分隔符错误：红字 `role=alert` 提示；运行时按仅删除处理。
- 总开关=关：模块置灰但可编辑；徽标显示“—”。

### 7.4 可访问性

- 折叠/展开使用 `aria-expanded`；
- 错误提示使用 `role="alert"`；
- 拖拽手柄提供 `aria-label="拖拽以改变组顺序"` 与键盘上下移动建议；
- 输出区 `aria-live="polite"` 保持现有行为。

---

## 8. 兼容与迁移

- 首次上线时，若检测到旧版“自定义过滤器（单列表）”配置：
  - 自动迁移为“组 1”，将旧关键词全部写入 `keywords`，`replacement=""`，`enabled=true`；
  - `masterEnabled` 延续旧值；
  - 写入 `schemaVersion=1`，并提示“已迁移旧配置”。

---

## 9. 性能与安全

- **性能**：O(groups × tokens)；常见规模下在主线程可接受。
- **内存**：按需拷贝 tokens；避免多次正则重编译（复用源码的缓存策略，如有）。
- **安全**：全部在浏览器内处理；导入 JSON 需严格校验避免 XSS 注入到 UI（不要直接 innerHTML 注入）。

---

## 10. QA 测试清单（摘选）

- ✅ 单组纯过滤：`socks` → 删除；
- ✅ 单组替换：`nsfw, uncensored` → `sfw`（仅插入一次，位置=首次命中）；
- ✅ 多组顺序管道：组1清理 A/B 并替换为 X；组2 针对 X 再处理；
- ✅ 分隔符错误：`sfw,nsfw` → 红字提示；运行按仅删除；
- ✅ 去重策略：输入已有 `sfw`，替换也包含 `sfw` → 保留靠前；
- ✅ 总开关=关：不执行、仍可编辑、徽标“—”；
- ✅ 命中计数：统计与显示正确；
- ✅ 导入/导出：schema 校验、预览、覆盖/追加；
- ✅ 回归样例：`1girl, uncensored, red hat, socks, nsfw` → `1girl, sfw, red hat`。

---

## 11. 发布与回滚

- **发布**：先灰度到 10% 用户，观察导入/迁移错误与性能；再全量放开。
- **回滚**：保留旧配置读取逻辑；发生严重问题时自动退回单列表模式并提示。

---

## 12. 变更记录

- **v1.0（2025-08-09）**：初版规范，落实分组、严格`, `分隔、匹配继承源码、命中徽标、导入导出、与提示词简化的执行顺序等。

