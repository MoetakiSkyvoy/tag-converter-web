<!DOCTYPE html>
<html>
<head>
    <title>提示词简化问题测试</title>
</head>
<body>
    <h2>提示词简化问题测试</h2>
    
    <script>
        // 模拟当前的escapeRegex函数
        function escapeRegex(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // 模拟当前有问题的simplifyTags函数
        function currentSimplifyTags(tags) {
            if (!tags || tags.length <= 1) return tags;
            
            // 按长度排序，短的在前面（更可能被包含）
            const sortedTags = tags.slice().sort((a, b) => a.length - b.length);
            const result = [];
            
            for (let i = 0; i < sortedTags.length; i++) {
                const currentTag = sortedTags[i];
                let isContained = false;
                
                // 检查当前tag是否被其他tag包含
                for (let j = i + 1; j < sortedTags.length; j++) {
                    const longerTag = sortedTags[j];
                    
                    // 使用词边界正则确保精确匹配
                    const pattern = new RegExp(`\\b${escapeRegex(currentTag)}\\b`, 'i');
                    
                    if (pattern.test(longerTag)) {
                        isContained = true;
                        break;
                    }
                }
                
                // 如果没有被包含，则保留该tag
                if (!isContained) {
                    result.push(currentTag);
                }
            }
            
            return result;
        }
        
        // 测试用例
        console.log('=== 提示词简化问题测试 ===');
        
        // 测试1：排序问题
        console.log('\n测试1：排序问题');
        const testTags1 = ['masterpiece', 'hat', 'blue eyes', 'red hat', 'girl'];
        console.log('输入:', testTags1);
        console.log('期望输出（按首字母排序）:', ['blue eyes', 'girl', 'masterpiece', 'red hat']);
        const result1 = currentSimplifyTags(testTags1);
        console.log('实际输出:', result1);
        
        // 测试2：词组包含问题
        console.log('\n测试2：词组包含问题');
        const testTags2 = [
            'unzen (azur lane)', 
            'unzen (sojourn through clear seas) (azur lane)'
        ];
        console.log('输入:', testTags2);
        console.log('期望输出:', ['unzen (sojourn through clear seas) (azur lane)']);
        const result2 = currentSimplifyTags(testTags2);
        console.log('实际输出:', result2);
        
        // 分析问题
        console.log('\n=== 问题分析 ===');
        console.log('问题1：排序被打乱 - result数组按处理顺序而非首字母顺序');
        console.log('问题2：词组包含检测失败');
        
        // 测试正则匹配
        const shortTag = 'unzen (azur lane)';
        const longTag = 'unzen (sojourn through clear seas) (azur lane)';
        const pattern = new RegExp(`\\b${escapeRegex(shortTag)}\\b`, 'i');
        console.log(`正则表达式: ${pattern}`);
        console.log(`测试 "${shortTag}" 是否包含在 "${longTag}" 中: ${pattern.test(longTag)}`);
        
        // 在页面显示结果
        document.body.innerHTML += `
            <div style="margin: 20px; padding: 20px; border: 1px solid #ccc;">
                <h3>测试结果</h3>
                <p><strong>测试1 - 排序问题:</strong></p>
                <p>输入: ${JSON.stringify(testTags1)}</p>
                <p>期望: ['blue eyes', 'girl', 'masterpiece', 'red hat']</p>
                <p>实际: ${JSON.stringify(result1)}</p>
                <p>排序正确: ${JSON.stringify(result1) === JSON.stringify(['blue eyes', 'girl', 'masterpiece', 'red hat']) ? '❌' : '❌'}</p>
                
                <p><strong>测试2 - 词组包含问题:</strong></p>
                <p>输入: ${JSON.stringify(testTags2)}</p>
                <p>期望: ${JSON.stringify(['unzen (sojourn through clear seas) (azur lane)'])}</p>
                <p>实际: ${JSON.stringify(result2)}</p>
                <p>包含检测正确: ${result2.length === 1 ? '✅' : '❌'}</p>
                
                <p><strong>正则匹配测试:</strong></p>
                <p>正则: ${pattern}</p>
                <p>匹配结果: ${pattern.test(longTag)}</p>
            </div>
        `;
    </script>
</body>
</html>