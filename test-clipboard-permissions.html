<!DOCTYPE html>
<html>
<head>
    <title>剪贴板权限管理测试</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px;
            line-height: 1.6;
        }
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
        }
        .success { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056CC; }
        button:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
        }
        .code {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>剪贴板权限管理系统测试</h1>
    
    <div class="test-section">
        <h2>🔍 当前状态检查</h2>
        <div id="status-display">检查中...</div>
        <button onclick="checkCurrentStatus()">🔄 重新检查状态</button>
        <button onclick="resetPermissions()">🔄 重置权限状态</button>
    </div>
    
    <div class="test-section">
        <h2>🧪 权限测试流程</h2>
        <p>这个测试将模拟主应用的权限管理流程：</p>
        <ol>
            <li>检查浏览器支持</li>
            <li>查询当前权限状态</li>
            <li>缓存权限结果</li>
            <li>处理权限请求</li>
        </ol>
        <button onclick="runPermissionTest()">▶️ 运行完整测试</button>
        <div id="test-results"></div>
    </div>
    
    <div class="test-section">
        <h2>📋 剪贴板操作测试</h2>
        <p>请先复制一些文本，然后测试读取功能：</p>
        <textarea placeholder="复制这些文本进行测试：Hello, World!" style="width: 100%; height: 60px;"></textarea>
        <br>
        <button onclick="testClipboardRead()">📋 测试读取剪贴板</button>
        <button onclick="testClipboardWrite()">📤 测试写入剪贴板</button>
        <div id="clipboard-results"></div>
    </div>
    
    <div class="test-section">
        <h2>🎯 改进效果说明</h2>
        <div class="info">
            <h3>权限管理优化：</h3>
            <ul>
                <li><strong>智能缓存：</strong>首次授权后，系统会记住权限状态</li>
                <li><strong>状态检查：</strong>使用Permissions API预检查权限</li>
                <li><strong>减少提示：</strong>已授权用户不再看到重复的权限提示</li>
                <li><strong>详细反馈：</strong>显示具体的操作进度和状态</li>
            </ul>
        </div>
        
        <div class="warning">
            <h3>⚠️ 浏览器限制说明：</h3>
            <p>由于安全考虑，浏览器的剪贴板权限有以下限制：</p>
            <ul>
                <li>必须在用户交互（点击）上下文中请求</li>
                <li>权限状态在页面刷新后可能需要重新检查</li>
                <li>某些浏览器可能仍会显示确认对话框</li>
                <li>需要HTTPS环境才能完全工作</li>
            </ul>
        </div>
    </div>
    
    <script>
        // 模拟主应用的权限管理器
        const TestClipboardManager = {
            permissionGranted: false,
            permissionChecked: false,
            
            async checkPermission() {
                try {
                    if (this.permissionChecked && this.permissionGranted) {
                        return true;
                    }
                    
                    if ('permissions' in navigator) {
                        const permission = await navigator.permissions.query({ name: 'clipboard-read' });
                        
                        if (permission.state === 'granted') {
                            this.permissionGranted = true;
                            this.permissionChecked = true;
                            return true;
                        } else if (permission.state === 'denied') {
                            this.permissionGranted = false;
                            this.permissionChecked = true;
                            return false;
                        }
                    }
                    
                    return false;
                } catch (error) {
                    console.log('权限检查失败:', error);
                    return false;
                }
            },
            
            async requestPermission() {
                try {
                    await navigator.clipboard.readText();
                    this.permissionGranted = true;
                    this.permissionChecked = true;
                    return true;
                } catch (error) {
                    if (error.name === 'NotAllowedError') {
                        this.permissionGranted = false;
                        this.permissionChecked = true;
                        return false;
                    }
                    this.permissionGranted = true;
                    this.permissionChecked = true;
                    return true;
                }
            },
            
            resetPermission() {
                this.permissionGranted = false;
                this.permissionChecked = false;
            }
        };
        
        async function checkCurrentStatus() {
            const statusDiv = document.getElementById('status-display');
            statusDiv.innerHTML = '<div class="info">检查中...</div>';
            
            let html = '';
            
            // 检查API支持
            const clipboardSupported = !!(navigator.clipboard && navigator.clipboard.readText);
            const permissionsSupported = 'permissions' in navigator;
            
            html += `<div class="status ${clipboardSupported ? 'success' : 'error'}">
                📱 剪贴板API支持: ${clipboardSupported ? '✅ 支持' : '❌ 不支持'}
            </div>`;
            
            html += `<div class="status ${permissionsSupported ? 'success' : 'warning'}">
                🔐 权限API支持: ${permissionsSupported ? '✅ 支持' : '⚠️ 不支持（将使用回退方案）'}
            </div>`;
            
            if (clipboardSupported) {
                try {
                    const hasPermission = await TestClipboardManager.checkPermission();
                    html += `<div class="status ${hasPermission ? 'success' : 'warning'}">
                        🎯 权限状态: ${hasPermission ? '✅ 已授权' : '⚠️ 需要授权'}
                    </div>`;
                    
                    html += `<div class="status info">
                        💾 缓存状态: 已检查=${TestClipboardManager.permissionChecked}, 已授权=${TestClipboardManager.permissionGranted}
                    </div>`;
                } catch (error) {
                    html += `<div class="status error">
                        ❌ 权限检查失败: ${error.message}
                    </div>`;
                }
            }
            
            statusDiv.innerHTML = html;
        }
        
        function resetPermissions() {
            TestClipboardManager.resetPermission();
            checkCurrentStatus();
        }
        
        async function runPermissionTest() {
            const resultsDiv = document.getElementById('test-results');
            let html = '<h3>测试结果：</h3>';
            
            try {
                // 步骤1：检查权限
                html += '<div class="info">步骤1: 检查权限状态...</div>';
                const hasPermission = await TestClipboardManager.checkPermission();
                html += `<div class="status ${hasPermission ? 'success' : 'warning'}">
                    权限状态: ${hasPermission ? '已有权限' : '需要请求权限'}
                </div>`;
                
                // 步骤2：如果没有权限，尝试请求
                if (!hasPermission) {
                    html += '<div class="info">步骤2: 请求权限...</div>';
                    const granted = await TestClipboardManager.requestPermission();
                    html += `<div class="status ${granted ? 'success' : 'error'}">
                        权限请求结果: ${granted ? '✅ 已授权' : '❌ 被拒绝'}
                    </div>`;
                } else {
                    html += '<div class="success">步骤2: 跳过权限请求（已有权限）</div>';
                }
                
                // 步骤3：测试读取
                html += '<div class="info">步骤3: 测试剪贴板读取...</div>';
                try {
                    const text = await navigator.clipboard.readText();
                    html += `<div class="status success">
                        ✅ 读取成功: "${text.substring(0, 50)}${text.length > 50 ? '...' : ''}"
                    </div>`;
                } catch (error) {
                    html += `<div class="status error">
                        ❌ 读取失败: ${error.message}
                    </div>`;
                }
                
            } catch (error) {
                html += `<div class="status error">
                    ❌ 测试过程出错: ${error.message}
                </div>`;
            }
            
            resultsDiv.innerHTML = html;
        }
        
        async function testClipboardRead() {
            const resultsDiv = document.getElementById('clipboard-results');
            try {
                const text = await navigator.clipboard.readText();
                resultsDiv.innerHTML = `<div class="status success">
                    ✅ 读取成功！内容: "${text}"
                </div>`;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">
                    ❌ 读取失败: ${error.message}
                </div>`;
            }
        }
        
        async function testClipboardWrite() {
            const resultsDiv = document.getElementById('clipboard-results');
            try {
                const testText = `测试时间: ${new Date().toLocaleTimeString()}`;
                await navigator.clipboard.writeText(testText);
                resultsDiv.innerHTML = `<div class="status success">
                    ✅ 写入成功！内容: "${testText}"
                </div>`;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">
                    ❌ 写入失败: ${error.message}
                </div>`;
            }
        }
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            checkCurrentStatus();
        });
    </script>
</body>
</html>