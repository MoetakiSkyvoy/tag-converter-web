# Tag格式转换器

一个智能的网页工具，支持Danbooru和Gelbooru两种格式的tag文本转换，将带权重的tag转换为纯净的逗号分隔格式。

## 支持格式

### Danbooru格式
```
General
?
1boy 1.4M
?
1girl 6.1M
```

### Gelbooru格式
```
Artist? tumitumico 18Character? queen marika the eternal 569Tag? 1girl 8032396? armlet 51903
```

## 功能特点

- 🔄 **实时转换**: 输入文本后自动处理转换
- 🎯 **多格式支持**: 自动识别Danbooru、Gelbooru和标准三种格式
- 🤖 **智能检测**: 根据文本结构自动选择对应的解析算法
- 📊 **权重处理**: 支持去除各种数字权重格式（如 369、3.69k、3M）
- 📋 **一键复制**: 点击复制按钮即可复制结果，带有视觉反馈
- 🔄 **粘贴并复制**: 一键从剪贴板粘贴、处理并复制结果，极致简化流程
- 🎯 **自定义过滤**: 支持正则表达式和词组的高级过滤功能
- 🔧 **提示词简化**: 智能移除被包含的冗余词汇，支持复杂词组检测
- 🔧 **保护括号**: 自动保留tag中的括号内容
- 📱 **响应式设计**: 支持移动端访问

## 转换逻辑

### 四阶段处理算法
采用先进的四阶段统一处理流程，确保所有格式的准确转换和自定义过滤：

#### 第一阶段：格式检测
- **Danbooru**: 包含换行符 + `?` 标记行
- **Gelbooru**: 单行文本 + `Artist?`/`Tag?` 等标识符
- **Standard**: 已经是逗号分隔的标准格式

#### 第二阶段：内容提取
- **Danbooru**: 提取 `?` 后面的内容行
- **Gelbooru**: 智能解析分类标识符，提取有效内容，移除数字权重
- **Standard**: 直接使用原始输入

#### 第三阶段：统一清理
- 按逗号精确分割，保护词组完整性
- 移除纯分类标识符
- 删除末尾数字权重（支持 369、3.69k、3M 等格式）
- 标准化空格和去重处理

#### 第四阶段：自定义过滤
- 应用用户自定义的过滤规则
- 支持正则表达式和普通字符串匹配
- 过滤不需要的tag和词组
- 输出最终的纯净tag列表

## 高级功能

### 🔄 粘贴并复制功能
一键完成从剪贴板粘贴内容、自动处理、并复制结果的完整流程：

1. **智能权限管理**: 首次授权后记住剪贴板权限，避免重复确认
2. **流程简化**: 原来的4步操作（复制→粘贴→转换→复制）简化为1步
3. **状态反馈**: 实时显示操作进度（权限请求→读取→处理→复制→完成）
4. **错误处理**: 智能处理权限拒绝、空内容、格式错误等情况
5. **浏览器兼容**: 支持Chrome 76+、Firefox 79+、Safari 13.1+等现代浏览器

### 🎯 分组过滤器系统

#### 系统架构
全新的分组过滤器系统，支持多组并行处理和灵活的配置管理：

#### 核心功能
- **分组管理**: 创建多个独立的过滤组，每组处理不同类型的关键词
- **实时统计**: 显示当前命中数量，与输入内容实时同步
- **拖拽排序**: 支持拖拽改变过滤组的执行顺序
- **导入导出**: 完整的配置导入导出功能，支持配置备份和共享
- **替换功能**: 支持将匹配的关键词替换为指定内容

#### 分组配置
每个过滤组包含以下配置项：
- **组名**: 自定义组名，便于管理和识别
- **启用状态**: 独立的开关控制，可临时禁用某个组
- **过滤关键词**: 支持多个关键词，用回车键添加
- **替换短语**: 可选的替换内容，支持多个替换词

#### 过滤示例
```
组1 - 审查相关:
  关键词: censored, mosaic, bar censor
  替换: uncensored

组2 - 质量控制:  
  关键词: bad quality, worst quality, low res
  替换: (留空，仅删除)

组3 - 特殊标记:
  关键词: watermark, logo, \d+px
  替换: high quality
```

#### 正则表达式支持
每个关键词都支持正则表达式：
- `\d+px` - 匹配像素尺寸
- `bad.*quality` - 匹配包含"bad"和"quality"的词组
- `^nsfw$` - 精确匹配"nsfw"

### 🔧 提示词简化功能
智能移除被其他提示词包含的冗余词汇：

#### 工作原理
- **简单词汇**: "hat" 被 "red hat" 包含时自动移除
- **复杂词组**: "unzen (azur lane)" 被 "unzen (sojourn through clear seas) (azur lane)" 语义包含时移除
- **避免误删**: "censored" 不会被 "uncensored" 误删
- **保持顺序**: 简化后保持用户输入的原始顺序

#### 功能特点
- ✅ **智能词组解析**: 支持复杂括号结构的语义分析
- ✅ **双层检测**: 简单词汇 + 复杂词组的分离检测算法
- ✅ **精确匹配**: 避免部分匹配导致的误删
- ✅ **顺序保持**: 输出保持用户输入的原始顺序
- ✅ **依赖管理**: 依赖主过滤器开关，关闭时自动禁用

### 分组过滤器功能特点
- ✅ **多组并行**: 支持创建多个过滤组，按顺序依次执行
- ✅ **实时计数**: 每个组显示当前命中数量，与输入内容实时绑定
- ✅ **拖拽排序**: 通过拖拽调整过滤组的执行顺序
- ✅ **独立开关**: 每个组都有独立的启用/禁用开关
- ✅ **智能替换**: 支持将匹配内容替换为指定词汇
- ✅ **配置管理**: 完整的导入/导出功能，支持配置备份
- ✅ **正则表达式**: 每个关键词都支持正则表达式模式
- ✅ **容错处理**: 无效正则自动转为普通匹配
- ✅ **持久存储**: 所有设置自动保存到本地存储
- ✅ **可视化管理**: 直观的UI界面，支持关键词标签化显示

## 使用方法

### 基础转换
1. 打开 `index.html` 文件
2. 粘贴来自Danbooru、Gelbooru或其他来源的原始tag文本
3. 系统自动识别格式并实时转换
4. 查看转换结果和格式检测信息

### 分组过滤
1. 点击"🎯 自定义过滤器"区域的"▼ 展开设置"
2. 开启过滤器总开关
3. 点击"➕"按钮创建新的过滤组
4. 为过滤组命名并添加关键词（支持正则表达式）
5. 可选设置替换短语
6. 通过拖拽调整组的执行顺序
7. 使用导入/导出功能备份或共享配置

### 复制结果
- 点击"📋 复制结果"按钮一键复制转换后的tag列表
- 按钮会显示"✅ 已复制"确认信息

### 其他操作
- **📝 加载示例**: 循环加载不同格式的示例数据，防重复点击和内容重复
- **🗑️ 清空内容**: 一键清空所有输入和输出内容，重置应用状态
- **💡 查看详情**: 点击页脚"关于"链接查看软件详细信息和功能介绍

### 💡 软件信息弹窗
v5.0版本现代化模态弹窗，集中展示软件信息：
- **📊 核心功能**: 四阶段处理、格式检测、清理去重等
- **🎯 支持格式**: Danbooru、Gelbooru、通用格式
- **🔍 高级特性**: 分组过滤器、实时统计、拖拽排序、配置管理等
- **🔧 技术特性**: 前端架构、本地处理、响应式设计
- **💻 版本信息**: 详细的软件版本和兼容性信息

弹窗交互：
- 点击页脚"关于"链接打开
- 点击右上角圆角正方形"×"按钮关闭
- 点击背景区域关闭，按ESC键快速关闭
- 响应式设计，完美适配移动端

## 技术实现

### 架构特点
- **纯前端实现**: 纯HTML/CSS/JavaScript，无需构建工具
- **模块化设计**: 面向对象架构，清晰的职责分离
- **四阶段算法**: 格式检测→内容提取→统一清理→自定义过滤
- **配置系统**: 集中的CONFIG对象管理所有配置

### 核心模块
- **TagConverter**: 主控制器，统筹整个转换流程
- **FormatDetector**: 格式检测，智能识别输入格式
- **ContentExtractor**: 内容提取，按格式提取有效内容
- **ContentCleaner**: 内容清理，标准化和去重处理
- **GroupedFilterManager**: 分组过滤器管理，支持多组并行过滤和配置管理
- **UIManager**: 界面管理，统一UI交互逻辑和实时状态更新
- **ExampleManager**: 示例管理，防重复加载和点击冲突

### 技术特色
- **智能格式检测**: 多重启发式算法识别输入格式
- **词组完整性保护**: 避免复合词组被错误分割
- **分组过滤架构**: 支持多组并行处理和独立配置
- **实时计数绑定**: 命中统计与当前输入内容实时绑定
- **拖拽交互系统**: 原生拖拽API实现组排序功能
- **配置序列化**: 完整的JSON配置导入导出系统
- **正则表达式引擎**: 每个关键词支持复杂模式匹配
- **持久化存储**: localStorage保存完整的分组配置
- **实时处理**: 输入变化时自动重新转换和统计
- **响应式设计**: 完美支持移动端和桌面端
- **智能状态管理**: 空输入时自动重置所有计数和状态
- **防冲突设计**: 防止重复点击和意外操作

### 性能优化
- **预编译模式**: 正则表达式预编译，避免重复解析
- **短路逻辑**: 过滤匹配使用短路算法提高性能
- **内存管理**: 合理的对象生命周期管理
- **事件节流**: 避免频繁的DOM操作
- **状态缓存**: 智能缓存计算结果，减少重复处理
- **异步处理**: 使用异步机制确保UI响应流畅

## 算法优势

- **多格式兼容**: 自动识别并处理三种不同的输入格式
- **词组保护**: 确保复合词组（如 `dark-skinned female`）不被分割
- **精确清理**: 只移除真正的权重数字，保留有意义内容
- **智能过滤**: 支持正则表达式和词组的自定义过滤
- **容错性强**: 对格式变化和边界情况有良好的处理能力
- **用户友好**: 简洁的界面和丰富的交互反馈
- **状态管理**: 智能的应用状态管理，避免UI显示异常
- **操作保护**: 防重复操作和意外冲突，提升用户体验

## 更新日志

### v5.0 (2025-08-11) - 分组过滤版 🎉
- 🎯 **分组过滤系统**: 全新的多组并行过滤架构，支持独立配置和管理
- 📊 **实时统计绑定**: 命中计数与当前输入内容实时绑定，摒弃"上次"概念
- 🔄 **拖拽排序**: 支持拖拽改变过滤组执行顺序，直观的交互体验
- 📥📤 **配置管理**: 完整的导入/导出功能，支持配置备份和共享
- 🔄 **智能替换**: 支持将匹配内容替换为指定词汇，而不仅是删除
- 🏷️ **标签化管理**: 关键词以标签形式显示，支持点击删除
- 🎛️ **独立开关**: 每个过滤组都有独立的启用/禁用控制
- 🎨 **UI优化**: 圆角正方形关闭按钮、菜单层级优化、边框渲染修复
- ⚡ **性能提升**: 优化过滤算法，支持大量关键词的高效处理
- 🧹 **代码重构**: 移除过时功能，优化代码结构和文档

### v4.4 (2025-08-08)
- 🎨 **UI布局重构**: 重新组织页面元素顺序，优化用户操作流程
- 📱 **模态弹窗系统**: 将软件信息和功能介绍整合到现代化弹窗中
- ✨ **简化设计**: 精简页脚为带链接的简洁设计，界面更加清爽
- 🔧 **交互增强**: 添加ESC键关闭、点击背景关闭等便捷操作
- 💡 **视觉优化**: 优化关闭按钮样式，采用右对齐设计
- 📝 **语义化HTML**: 功能列表采用标准ul/li结构，提升可读性
- 🧹 **代码清理**: 移除测试文件和无用示例，项目更整洁

### v4.3
- 🔄 **粘贴并复制**: 一键完成剪贴板粘贴→转换→复制的完整流程  
- 🎯 **过滤逻辑修复**: 修复部分匹配问题（如"censored"vs"uncensored"）
- 🤖 **简化算法增强**: 改进复杂词组包含检测（如unzen案例）
- 🔗 **UI依赖管理**: 简化功能正确依赖主过滤器开关
- 📋 **顺序保持**: 简化结果保持用户输入顺序
- ⚠️ **错误处理**: 全面的错误处理和用户友好反馈

### v4.2
- 🔄 **提示词简化**: 自动移除被其他提示词包含的冗余词汇
- 🧠 **复杂词组支持**: 智能处理括号词组和语义关系
- 🎛️ **依赖管理**: 完善UI状态管理，处理过滤器依赖关系

### v4.1
- ✅ 修复格式状态在空输入时不重置的问题
- ✅ 优化示例加载器，防止重复点击和内容重复
- ✅ 完善代码注释和文档
- ✅ 提升用户体验和操作流畅性

### v4.0
- ✅ 添加自定义过滤器系统
- ✅ 支持正则表达式和词组过滤
- ✅ 实现设置持久化存储
- ✅ 优化过滤算法性能

### v3.0
- ✅ 完整架构重构，采用面向对象设计
- ✅ 现代化UI界面和交互体验
- ✅ 模块化代码结构
- ✅ 响应式设计支持

### v2.0
- ✅ 添加Gelbooru格式支持
- ✅ 统一处理算法
- ✅ 智能格式检测

### v1.0
- ✅ 基础Danbooru格式支持
- ✅ 核心转换功能
- ✅ 简单UI界面