# Tag格式转换器

一个智能的网页工具，支持Danbooru和Gelbooru两种格式的tag文本转换，将带权重的tag转换为纯净的逗号分隔格式。

## 支持格式

### Danbooru格式
```
General
?
1boy 1.4M
?
1girl 6.1M
```

### Gelbooru格式
```
Artist? tumitumico 18Character? queen marika the eternal 569Tag? 1girl 8032396? armlet 51903
```

## 功能特点

- 🔄 **实时转换**: 输入文本后自动处理转换
- 🎯 **双格式支持**: 自动识别Danbooru和Gelbooru两种网站格式
- 🤖 **智能检测**: 根据文本结构自动选择对应的解析算法
- 📊 **权重处理**: 支持去除各种数字权重格式（如 369、3.69k、3M）
- 📋 **一键复制**: 点击复制按钮即可复制结果，带有视觉反馈
- 🔧 **保护括号**: 自动保留tag中的括号内容
- 📱 **响应式设计**: 支持移动端访问

## 转换逻辑

### 四阶段处理算法
采用先进的四阶段统一处理流程，确保所有格式的准确转换和自定义过滤：

#### 第一阶段：格式检测
- **Danbooru**: 包含换行符 + `?` 标记行
- **Gelbooru**: 单行文本 + `Artist?`/`Tag?` 等标识符
- **Standard**: 已经是逗号分隔的标准格式

#### 第二阶段：内容提取
- **Danbooru**: 提取 `?` 后面的内容行
- **Gelbooru**: 智能解析分类标识符，提取有效内容，移除数字权重
- **Standard**: 直接使用原始输入

#### 第三阶段：统一清理
- 按逗号精确分割，保护词组完整性
- 移除纯分类标识符
- 删除末尾数字权重（支持 369、3.69k、3M 等格式）
- 标准化空格和去重处理

#### 第四阶段：自定义过滤
- 应用用户自定义的过滤规则
- 支持正则表达式和普通字符串匹配
- 过滤不需要的tag和词组
- 输出最终的纯净tag列表

## 自定义过滤器

### 基本用法
在过滤器设置中输入要过滤的关键词，用逗号分隔：
```
watermark, nsfw, bad quality, beautiful girl
```

### 正则表达式支持
支持使用正则表达式进行高级过滤：
```
watermark, nsfw, \d+px, .*(watermark|logo).*
```

### 过滤示例
| 过滤词 | 匹配示例 | 说明 |
|--------|----------|------|
| `watermark` | watermark, watermarked | 过滤包含watermark的tag |
| `bad quality` | bad quality | 过滤完整词组 |
| `\d+px` | 1024px, 512px | 过滤像素尺寸tag |
| `nsfw` | nsfw, NSFW | 大小写不敏感匹配 |

### 功能特点
- ✅ **词组支持**: 支持包含空格的词组过滤
- ✅ **正则表达式**: 支持复杂的模式匹配
- ✅ **智能匹配**: 自动检测正则表达式语法
- ✅ **容错处理**: 无效正则自动转为普通匹配
- ✅ **持久存储**: 设置自动保存到本地存储
- ✅ **实时统计**: 显示过滤效果和规则数量

## 使用方法

### 基础转换
1. 打开 `index.html` 文件
2. 粘贴来自Danbooru、Gelbooru或其他来源的原始tag文本
3. 系统自动识别格式并实时转换
4. 查看转换结果和格式检测信息

### 自定义过滤
1. 点击"🎯 自定义过滤器"区域的"展开设置"
2. 开启过滤器开关
3. 在输入框中输入要过滤的关键词（逗号分隔）
4. 系统自动应用过滤规则并重新转换

### 复制结果
- 点击"📋 复制结果"按钮一键复制转换后的tag列表
- 按钮会显示"✅ 已复制"确认信息

### 其他操作
- **📝 加载示例**: 循环加载不同格式的示例数据，防重复点击和内容重复
- **🗑️ 清空内容**: 一键清空所有输入和输出内容，重置应用状态

## 技术实现

### 架构特点
- **纯前端实现**: 纯HTML/CSS/JavaScript，无需构建工具
- **模块化设计**: 面向对象架构，清晰的职责分离
- **四阶段算法**: 格式检测→内容提取→统一清理→自定义过滤
- **配置系统**: 集中的CONFIG对象管理所有配置

### 核心模块
- **TagConverter**: 主控制器，统筹整个转换流程
- **FormatDetector**: 格式检测，智能识别输入格式
- **ContentExtractor**: 内容提取，按格式提取有效内容
- **ContentCleaner**: 内容清理，标准化和去重处理
- **FilterManager**: 过滤器管理，自定义关键词过滤
- **UIManager**: 界面管理，统一UI交互逻辑
- **ExampleManager**: 示例管理，防重复加载和点击冲突

### 技术特色
- **智能格式检测**: 多重启发式算法识别输入格式
- **词组完整性保护**: 避免复合词组被错误分割
- **正则表达式引擎**: 支持复杂的模式匹配和过滤
- **持久化存储**: localStorage保存用户设置
- **实时处理**: 输入变化时自动重新转换
- **响应式设计**: 完美支持移动端和桌面端
- **智能状态管理**: 空输入时自动重置状态显示
- **防冲突设计**: 防止重复点击和意外操作

### 性能优化
- **预编译模式**: 正则表达式预编译，避免重复解析
- **短路逻辑**: 过滤匹配使用短路算法提高性能
- **内存管理**: 合理的对象生命周期管理
- **事件节流**: 避免频繁的DOM操作
- **状态缓存**: 智能缓存计算结果，减少重复处理
- **异步处理**: 使用异步机制确保UI响应流畅

## 算法优势

- **多格式兼容**: 自动识别并处理三种不同的输入格式
- **词组保护**: 确保复合词组（如 `dark-skinned female`）不被分割
- **精确清理**: 只移除真正的权重数字，保留有意义内容
- **智能过滤**: 支持正则表达式和词组的自定义过滤
- **容错性强**: 对格式变化和边界情况有良好的处理能力
- **用户友好**: 简洁的界面和丰富的交互反馈
- **状态管理**: 智能的应用状态管理，避免UI显示异常
- **操作保护**: 防重复操作和意外冲突，提升用户体验

## 更新日志

### v4.1 (2025-08-08)
- ✅ 修复格式状态在空输入时不重置的问题
- ✅ 优化示例加载器，防止重复点击和内容重复
- ✅ 完善代码注释和文档
- ✅ 提升用户体验和操作流畅性

### v4.0
- ✅ 添加自定义过滤器系统
- ✅ 支持正则表达式和词组过滤
- ✅ 实现设置持久化存储
- ✅ 优化过滤算法性能

### v3.0
- ✅ 完整架构重构，采用面向对象设计
- ✅ 现代化UI界面和交互体验
- ✅ 模块化代码结构
- ✅ 响应式设计支持

### v2.0
- ✅ 添加Gelbooru格式支持
- ✅ 统一处理算法
- ✅ 智能格式检测

### v1.0
- ✅ 基础Danbooru格式支持
- ✅ 核心转换功能
- ✅ 简单UI界面